<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Device - IoT Device Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .font-sans { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans transition-colors duration-300">

    <div class="flex">
        <!-- Sidebar Navigation -->
        <nav class="w-24 bg-white dark:bg-gray-800/50 p-2 space-y-4 flex flex-col items-center shadow-md">
            <div class="p-2">
                <div data-lucide="zap" class="text-blue-500" style="width: 32px; height: 32px;"></div>
            </div>
            <a href="index.html" class="nav-item flex flex-col items-center justify-center space-y-1 w-full py-3 rounded-lg transition-colors text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                <div data-lucide="home" style="width: 24px; height: 24px;"></div>
                <span class="text-xs font-medium">Dashboard</span>
            </a>
            <a href="index.html#billing" class="nav-item flex flex-col items-center justify-center space-y-1 w-full py-3 rounded-lg transition-colors text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                <div data-lucide="package" style="width: 24px; height: 24px;"></div>
                <span class="text-xs font-medium">Plans</span>
            </a>
            <div class="flex-grow"></div>
            <button id="theme-toggle" class="p-3 rounded-full transition-all duration-300 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                <div data-lucide="sun" id="theme-icon-sun" class="hidden"></div>
                <div data-lucide="moon" id="theme-icon-moon"></div>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 h-screen overflow-y-auto">
            <!-- Header -->
            <header class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-gray-100/80 dark:bg-gray-900/80 backdrop-blur-sm z-10">
                <div class="flex items-center space-x-2">
                    <div data-lucide="zap" class="text-blue-500" style="width: 28px; height: 28px;"></div>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Add New Device</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">User: 012-3456789</span>
                    <div data-lucide="bell" class="text-gray-500 dark:text-gray-400 cursor-pointer"></div>
                    <div data-lucide="settings" class="text-gray-500 dark:text-gray-400 cursor-pointer"></div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="p-6">
                <div class="max-w-4xl mx-auto">
                    <!-- Breadcrumb -->
                    <div class="flex items-center space-x-2 mb-6 text-sm text-gray-500 dark:text-gray-400">
                        <a href="index.html" class="hover:text-blue-500">Dashboard</a>
                        <div data-lucide="chevron-right" style="width: 16px; height: 16px;"></div>
                        <span>Add Device</span>
                    </div>

                    <!-- Device Addition Form -->
                    <div class="bg-white dark:bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-lg p-8">
                        <h2 class="text-3xl font-bold mb-8 text-gray-800 dark:text-white">Add Your IoT Device</h2>
                        
                        <form id="add-device-form" class="space-y-8">
                            <!-- Step 1: Device Discovery -->
                            <div class="step" data-step="1">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Step 1: Device Discovery</h3>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Device Identification Method</label>
                                        <select id="discovery-method" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
                                            <option value="sim">SIM Number</option>
                                            <option value="mac">MAC Address</option>
                                            <option value="qr">QR Code</option>
                                            <option value="manual">Manual Entry</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label id="identifier-label" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">SIM Number</label>
                                        <input id="device-identifier" type="text" placeholder="e.g., 89xxxxxxxxxxxxxx" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
                                    </div>
                                </div>
                                <button type="button" id="discover-device" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                    Discover Device
                                </button>
                            </div>

                            <!-- Step 2: Device Information -->
                            <div class="step hidden" data-step="2">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Step 2: Device Information</h3>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Device Name</label>
                                        <input id="device-name" type="text" placeholder="e.g., Living Room AC" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Device Location</label>
                                        <input id="device-location" type="text" placeholder="e.g., Living Room" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Device Category</label>
                                        <select id="device-category" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
                                            <option value="">Select Category</option>
                                            <option value="climate">Climate Control (AC, Heater, Fan)</option>
                                            <option value="lighting">Smart Lighting</option>
                                            <option value="security">Security (Camera, Lock, Sensor)</option>
                                            <option value="irrigation">Irrigation (Sprinkler, Drip System)</option>
                                            <option value="energy">Energy Monitor</option>
                                            <option value="appliance">Smart Appliance</option>
                                            <option value="sensor">Environmental Sensor</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Specific Device Type</label>
                                        <select id="device-type" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
                                            <option value="">Select Category First</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Device Controls -->
                            <div class="step hidden" data-step="3">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Step 3: Device Controls</h3>
                                <div id="device-controls" class="space-y-6">
                                    <!-- Controls will be dynamically generated based on device type -->
                                </div>
                            </div>

                            <!-- Step 4: Plan Assignment -->
                            <div class="step hidden" data-step="4">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Step 4: Plan Assignment</h3>
                                <div class="grid md:grid-cols-3 gap-6">
                                    <div class="plan-option p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-colors" data-plan="basic">
                                        <div class="flex items-center space-x-3 mb-3">
                                            <div data-lucide="package" class="text-blue-500" style="width: 24px; height: 24px;"></div>
                                            <h4 class="font-semibold text-gray-800 dark:text-white">Basic IoT</h4>
                                        </div>
                                        <p class="text-2xl font-bold text-gray-900 dark:text-white">$5<span class="text-sm font-normal text-gray-500">/mo</span></p>
                                        <ul class="text-sm text-gray-600 dark:text-gray-300 mt-2 space-y-1">
                                            <li>• Up to 3 devices</li>
                                            <li>• Basic controls</li>
                                            <li>• Standard alerts</li>
                                        </ul>
                                    </div>
                                    <div class="plan-option p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-colors" data-plan="premium">
                                        <div class="flex items-center space-x-3 mb-3">
                                            <div data-lucide="star" class="text-blue-500" style="width: 24px; height: 24px;"></div>
                                            <h4 class="font-semibold text-gray-800 dark:text-white">Premium IoT</h4>
                                        </div>
                                        <p class="text-2xl font-bold text-gray-900 dark:text-white">$15<span class="text-sm font-normal text-gray-500">/mo</span></p>
                                        <ul class="text-sm text-gray-600 dark:text-gray-300 mt-2 space-y-1">
                                            <li>• Up to 10 devices</li>
                                            <li>• Advanced automation</li>
                                            <li>• Cloud storage (10GB)</li>
                                            <li>• AI insights</li>
                                        </ul>
                                    </div>
                                    <div class="plan-option p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-colors" data-plan="security">
                                        <div class="flex items-center space-x-3 mb-3">
                                            <div data-lucide="shield" class="text-blue-500" style="width: 24px; height: 24px;"></div>
                                            <h4 class="font-semibold text-gray-800 dark:text-white">Home Security</h4>
                                        </div>
                                        <p class="text-2xl font-bold text-gray-900 dark:text-white">$20<span class="text-sm font-normal text-gray-500">/mo</span></p>
                                        <ul class="text-sm text-gray-600 dark:text-gray-300 mt-2 space-y-1">
                                            <li>• Unlimited security devices</li>
                                            <li>• 24/7 monitoring</li>
                                            <li>• Cloud storage (30GB)</li>
                                            <li>• Emergency dispatch</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Navigation Buttons -->
                            <div class="flex justify-between pt-6 border-t border-gray-200 dark:border-gray-700">
                                <button type="button" id="prev-step" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors hidden">
                                    Previous
                                </button>
                                <button type="button" id="next-step" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                    Next
                                </button>
                                <button type="submit" id="add-device-submit" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors hidden">
                                    Add Device
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-lg p-8 text-center max-w-md">
            <div class="mb-4">
                <div data-lucide="check-circle" class="text-green-500 mx-auto" style="width: 64px; height: 64px;"></div>
            </div>
            <h3 class="text-2xl font-bold mb-2 text-gray-800 dark:text-white">Device Added Successfully!</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-6">Your new IoT device has been added to your hub and is ready to use.</p>
            <div class="space-y-3">
                <a href="index.html" class="block w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    Go to Dashboard
                </a>
                <button id="add-another" class="w-full py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                    Add Another Device
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Device type mappings
            const deviceTypes = {
                climate: [
                    { value: 'smart-ac', label: 'Smart Air Conditioner', icon: 'wind', controls: ['temperature', 'mode', 'fan-speed'] },
                    { value: 'smart-heater', label: 'Smart Heater', icon: 'flame', controls: ['temperature', 'mode'] },
                    { value: 'smart-fan', label: 'Smart Fan', icon: 'wind', controls: ['speed', 'oscillation'] }
                ],
                lighting: [
                    { value: 'smart-bulb', label: 'Smart Bulb', icon: 'lightbulb', controls: ['brightness', 'color', 'schedule-start', 'schedule-end'] },
                    { value: 'smart-switch', label: 'Smart Switch', icon: 'toggle-left', controls: ['power', 'schedule-start', 'schedule-end'] },
                    { value: 'smart-strip', label: 'Smart LED Strip', icon: 'zap', controls: ['brightness', 'color', 'pattern', 'schedule-start', 'schedule-end'] }
                ],
                security: [
                    { value: 'security-camera', label: 'Security Camera', icon: 'camera', controls: ['recording', 'motion-detection', 'night-vision'] },
                    { value: 'smart-lock', label: 'Smart Lock', icon: 'lock', controls: ['lock-status', 'auto-lock', 'access-codes'] },
                    { value: 'motion-sensor', label: 'Motion Sensor', icon: 'activity', controls: ['sensitivity', 'detection-range'] }
                ],
                irrigation: [
                    { value: 'smart-sprinkler', label: 'Smart Sprinkler', icon: 'droplet', controls: ['water-flow', 'schedule-start', 'schedule-end', 'zones'] },
                    { value: 'drip-system', label: 'Drip Irrigation', icon: 'droplets', controls: ['flow-rate', 'schedule-start', 'schedule-end', 'moisture-sensor'] }
                ],
                energy: [
                    { value: 'smart-meter', label: 'Smart Meter', icon: 'zap', controls: ['monitoring', 'alerts'] },
                    { value: 'solar-monitor', label: 'Solar Panel Monitor', icon: 'sun', controls: ['output-tracking', 'efficiency'] },
                    { value: 'basic-monitor', label: 'Basic Energy Monitor', icon: 'zap', controls: [] }
                ],
                appliance: [
                    { value: 'smart-refrigerator', label: 'Smart Refrigerator', icon: 'box', controls: ['temperature', 'inventory'] },
                    { value: 'smart-washer', label: 'Smart Washer', icon: 'washing-machine', controls: ['cycle', 'schedule'] }
                ],
                sensor: [
                    { value: 'temp-sensor', label: 'Temperature Sensor', icon: 'thermometer', controls: ['monitoring', 'alerts'] },
                    { value: 'humidity-sensor', label: 'Humidity Sensor', icon: 'droplets', controls: ['monitoring', 'alerts'] },
                    { value: 'air-quality', label: 'Air Quality Monitor', icon: 'wind', controls: ['monitoring', 'alerts'] },
                    { value: 'simple-sensor', label: 'Simple Sensor', icon: 'activity', controls: [] }
                ]
            };

            // Control templates
            const controlTemplates = {
                temperature: {
                    label: 'Temperature Control',
                    type: 'range',
                    min: 16,
                    max: 30,
                    default: 22,
                    unit: '°C'
                },
                mode: {
                    label: 'Mode',
                    type: 'select',
                    options: ['Auto', 'Cool', 'Heat', 'Fan', 'Dry']
                },
                'fan-speed': {
                    label: 'Fan Speed',
                    type: 'select',
                    options: ['Low', 'Medium', 'High', 'Auto']
                },
                speed: {
                    label: 'Speed',
                    type: 'range',
                    min: 1,
                    max: 5,
                    default: 3,
                    unit: 'levels'
                },
                brightness: {
                    label: 'Brightness',
                    type: 'range',
                    min: 0,
                    max: 100,
                    default: 50,
                    unit: '%'
                },
                color: {
                    label: 'Color',
                    type: 'color',
                    default: '#ffffff'
                },
                schedule: {
                    label: 'Schedule',
                    type: 'time',
                    default: '08:00'
                },
                'schedule-start': {
                    label: 'Schedule Start Time',
                    type: 'time',
                    default: '18:00'
                },
                'schedule-end': {
                    label: 'Schedule End Time',
                    type: 'time',
                    default: '06:00'
                },
                power: {
                    label: 'Power',
                    type: 'toggle',
                    default: false
                },
                'lock-status': {
                    label: 'Lock Status',
                    type: 'toggle',
                    default: true
                },
                'water-flow': {
                    label: 'Water Flow',
                    type: 'range',
                    min: 0,
                    max: 100,
                    default: 50,
                    unit: '%'
                },
                'flow-rate': {
                    label: 'Flow Rate',
                    type: 'range',
                    min: 0,
                    max: 10,
                    default: 5,
                    unit: 'L/min'
                },
                monitoring: {
                    label: 'Monitoring',
                    type: 'toggle',
                    default: true
                },
                alerts: {
                    label: 'Alerts',
                    type: 'toggle',
                    default: true
                },
                pattern: {
                    label: 'Light Pattern',
                    type: 'select',
                    options: ['Solid', 'Fade', 'Pulse', 'Rainbow', 'Wave', 'Chase']
                },
                zones: {
                    label: 'Watering Zones',
                    type: 'select',
                    options: ['Front Yard', 'Back Yard', 'Garden', 'All Zones']
                },
                'moisture-sensor': {
                    label: 'Moisture Sensor',
                    type: 'toggle',
                    default: true
                },
                oscillation: {
                    label: 'Oscillation',
                    type: 'toggle',
                    default: false
                },
                'auto-lock': {
                    label: 'Auto Lock',
                    type: 'toggle',
                    default: true
                },
                'access-codes': {
                    label: 'Access Codes',
                    type: 'toggle',
                    default: true
                },
                'sensitivity': {
                    label: 'Sensitivity',
                    type: 'range',
                    min: 1,
                    max: 10,
                    default: 5,
                    unit: 'levels'
                },
                'detection-range': {
                    label: 'Detection Range',
                    type: 'range',
                    min: 1,
                    max: 20,
                    default: 10,
                    unit: 'meters'
                },
                'output-tracking': {
                    label: 'Output Tracking',
                    type: 'toggle',
                    default: true
                },
                efficiency: {
                    label: 'Efficiency Monitoring',
                    type: 'toggle',
                    default: true
                },
                inventory: {
                    label: 'Inventory Tracking',
                    type: 'toggle',
                    default: false
                },
                cycle: {
                    label: 'Wash Cycle',
                    type: 'select',
                    options: ['Quick', 'Normal', 'Heavy', 'Delicate', 'Auto']
                },
                recording: {
                    label: 'Recording',
                    type: 'toggle',
                    default: true
                },
                'motion-detection': {
                    label: 'Motion Detection',
                    type: 'toggle',
                    default: true
                },
                'night-vision': {
                    label: 'Night Vision',
                    type: 'toggle',
                    default: true
                }
            };

            let currentStep = 1;
            let selectedDevice = null;
            let selectedPlan = null;

            const plans = [
                { id: 'basic', name: 'Basic IoT', price: 5, icon: 'package', features: ['Up to 3 devices', 'Basic controls', 'Standard alerts']},
                { id: 'premium', name: 'Premium IoT', price: 15, icon: 'star', features: ['Up to 10 devices', 'Advanced automation', 'Cloud storage (10GB)', 'AI insights']},
                { id: 'security', name: 'Home Security', price: 20, icon: 'shield', features: ['Unlimited security devices', '24/7 monitoring', 'Cloud storage (30GB)', 'Emergency dispatch']},
            ];

            // DOM Elements
            const form = document.getElementById('add-device-form');
            const steps = document.querySelectorAll('.step');
            const prevBtn = document.getElementById('prev-step');
            const nextBtn = document.getElementById('next-step');
            const submitBtn = document.getElementById('add-device-submit');
            const discoverBtn = document.getElementById('discover-device');
            const categorySelect = document.getElementById('device-category');
            const typeSelect = document.getElementById('device-type');
            const discoveryMethod = document.getElementById('discovery-method');
            const identifierLabel = document.getElementById('identifier-label');
            const deviceIdentifier = document.getElementById('device-identifier');
            const planOptions = document.querySelectorAll('.plan-option');
            const successModal = document.getElementById('success-modal');
            const addAnotherBtn = document.getElementById('add-another');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIconSun = document.getElementById('theme-icon-sun');
            const themeIconMoon = document.getElementById('theme-icon-moon');

            // Event Listeners
            discoveryMethod.addEventListener('change', updateIdentifierLabel);
            categorySelect.addEventListener('change', updateDeviceTypes);
            typeSelect.addEventListener('change', updateDeviceControls);
            discoverBtn.addEventListener('click', handleDeviceDiscovery);
            prevBtn.addEventListener('click', previousStep);
            nextBtn.addEventListener('click', nextStep);
            submitBtn.addEventListener('click', handleSubmit);
            planOptions.forEach(option => option.addEventListener('click', selectPlan));
            addAnotherBtn.addEventListener('click', resetForm);
            themeToggle.addEventListener('click', handleThemeToggle);

            // Functions
            function updateIdentifierLabel() {
                const method = discoveryMethod.value;
                const labelMap = {
                    sim: 'SIM Number',
                    mac: 'MAC Address',
                    qr: 'QR Code',
                    manual: 'Device ID'
                };
                identifierLabel.textContent = labelMap[method];
                deviceIdentifier.placeholder = method === 'sim' ? 'e.g., 89xxxxxxxxxxxxxx' : 
                                             method === 'mac' ? 'e.g., AA:BB:CC:DD:EE:FF' :
                                             method === 'qr' ? 'Scan QR code or enter manually' :
                                             'e.g., DEVICE_001';
            }

            function updateDeviceTypes() {
                const category = categorySelect.value;
                typeSelect.innerHTML = '<option value="">Select Device Type</option>';
                
                if (category && deviceTypes[category]) {
                    deviceTypes[category].forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.value;
                        option.textContent = device.label;
                        typeSelect.appendChild(option);
                    });
                }
            }

            function updateDeviceControls() {
                const category = categorySelect.value;
                const type = typeSelect.value;
                const controlsContainer = document.getElementById('device-controls');
                
                if (!category || !type) {
                    controlsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Select device type to see available controls</p>';
                    return;
                }

                const device = deviceTypes[category].find(d => d.value === type);
                if (!device) return;

                selectedDevice = device;
                controlsContainer.innerHTML = '';

                // Check if device has any controls
                const availableControls = device.controls.filter(controlKey => controlTemplates[controlKey]);
                
                if (availableControls.length === 0) {
                    controlsContainer.innerHTML = `
                        <div class="p-6 bg-gray-50 dark:bg-gray-700 rounded-lg text-center">
                            <div class="mb-3">
                                <div data-lucide="settings" class="text-gray-400 mx-auto" style="width: 48px; height: 48px;"></div>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">No Controls Available</h3>
                            <p class="text-gray-500 dark:text-gray-400">This device type doesn't require any specific controls. It will be added with basic monitoring capabilities.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // Generate controls for available control types
                availableControls.forEach(controlKey => {
                    const control = controlTemplates[controlKey];
                    if (!control) return;

                    const controlDiv = document.createElement('div');
                    controlDiv.className = 'p-4 bg-gray-50 dark:bg-gray-700 rounded-lg';
                    
                    let controlHTML = `<label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">${control.label}</label>`;
                    
                    switch (control.type) {
                        case 'range':
                            controlHTML += `
                                <input type="range" min="${control.min}" max="${control.max}" value="${control.default}" 
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                                       data-control="${controlKey}">
                                <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-1">
                                    <span>${control.min}${control.unit}</span>
                                    <span id="${controlKey}-value">${control.default}${control.unit}</span>
                                    <span>${control.max}${control.unit}</span>
                                </div>
                            `;
                            break;
                        case 'select':
                            controlHTML += `
                                <select class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600" data-control="${controlKey}">
                                    ${control.options.map(opt => `<option value="${opt.toLowerCase()}">${opt}</option>`).join('')}
                                </select>
                            `;
                            break;
                        case 'color':
                            controlHTML += `
                                <input type="color" value="${control.default}" 
                                       class="w-full h-12 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer"
                                       data-control="${controlKey}">
                            `;
                            break;
                        case 'time':
                            controlHTML += `
                                <input type="time" value="${control.default}" 
                                       class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600"
                                       data-control="${controlKey}">
                            `;
                            break;
                        case 'toggle':
                            controlHTML += `
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" ${control.default ? 'checked' : ''} 
                                           class="sr-only peer" data-control="${controlKey}">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                    <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300">${control.default ? 'On' : 'Off'}</span>
                                </label>
                            `;
                            break;
                    }
                    
                    controlDiv.innerHTML = controlHTML;
                    controlsContainer.appendChild(controlDiv);
                });

                // Add event listeners for range sliders
                controlsContainer.querySelectorAll('input[type="range"]').forEach(slider => {
                    const valueDisplay = document.getElementById(slider.dataset.control + '-value');
                    if (valueDisplay) {
                        slider.addEventListener('input', (e) => {
                            const control = controlTemplates[e.target.dataset.control];
                            valueDisplay.textContent = e.target.value + control.unit;
                        });
                    }
                });

                // Add event listeners for toggle switches
                controlsContainer.querySelectorAll('input[type="checkbox"]').forEach(toggle => {
                    toggle.addEventListener('change', (e) => {
                        const label = e.target.parentElement.querySelector('span');
                        label.textContent = e.target.checked ? 'On' : 'Off';
                    });
                });
            }

            function handleDeviceDiscovery() {
                if (!deviceIdentifier.value.trim()) {
                    alert('Please enter device identifier');
                    return;
                }

                discoverBtn.textContent = 'Discovering...';
                discoverBtn.disabled = true;

                // Simulate discovery process
                setTimeout(() => {
                    discoverBtn.textContent = 'Device Found!';
                    discoverBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    discoverBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    
                    setTimeout(() => {
                        nextStep();
                    }, 1000);
                }, 2000);
            }

            function showStep(step) {
                steps.forEach((s, index) => {
                    s.classList.toggle('hidden', index + 1 !== step);
                });

                prevBtn.classList.toggle('hidden', step === 1);
                nextBtn.classList.toggle('hidden', step === 4);
                submitBtn.classList.toggle('hidden', step !== 4);
            }

            function nextStep() {
                if (currentStep < 4) {
                    currentStep++;
                    showStep(currentStep);
                }
            }

            function previousStep() {
                if (currentStep > 1) {
                    currentStep--;
                    showStep(currentStep);
                }
            }

            function selectPlan() {
                planOptions.forEach(option => {
                    option.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
                    option.classList.add('border-gray-200', 'dark:border-gray-600');
                });
                
                this.classList.remove('border-gray-200', 'dark:border-gray-600');
                this.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
                selectedPlan = this.dataset.plan;
            }

            async function loadDevices() {
                try {
                    console.log('Loading devices from API...');
                    const response = await fetch('/api/devices');
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error:', errorText);
                        throw new Error(`Failed to load devices: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('Loaded devices from API:', data);
                    return data.devices || [];
                } catch (error) {
                    console.error('Error loading devices from API:', error);
                    
                    // Fallback 1: try to load from local file
                    try {
                        const response = await fetch('devices.json');
                        if (response.ok) {
                            const data = await response.json();
                            console.log('Loaded devices from local file:', data);
                            return data.devices || [];
                        }
                    } catch (fallbackError) {
                        console.error('Fallback loading from file failed:', fallbackError);
                    }
                    
                    // Fallback 2: try to load from localStorage
                    try {
                        const stored = localStorage.getItem('iot-devices');
                        if (stored) {
                            const data = JSON.parse(stored);
                            console.log('Loaded devices from localStorage:', data);
                            return data.devices || [];
                        }
                    } catch (localStorageError) {
                        console.error('Fallback loading from localStorage failed:', localStorageError);
                    }
                    
                    return [];
                }
            }

            async function saveDevices(devices) {
                try {
                    const data = {
                        devices: devices,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    console.log('Saving devices to API:', data);
                    
                    const response = await fetch('/api/devices', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    console.log('Save response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Save API Error:', errorText);
                        throw new Error(`Failed to save devices: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log('Save result:', result);
                    return true;
                } catch (error) {
                    console.error('Error saving devices:', error);
                    
                    // Fallback: try to save to localStorage for demo purposes
                    try {
                        localStorage.setItem('iot-devices', JSON.stringify({
                            devices: devices,
                            lastUpdated: new Date().toISOString()
                        }));
                        console.log('Saved to localStorage as fallback');
                        return true;
                    } catch (fallbackError) {
                        console.error('Fallback save failed:', fallbackError);
                        return false;
                    }
                }
            }

            function handleSubmit(e) {
                e.preventDefault();
                
                if (!selectedPlan) {
                    alert('Please select a plan');
                    return;
                }

                submitBtn.textContent = 'Adding Device...';
                submitBtn.disabled = true;

                // Collect form data
                const deviceName = document.getElementById('device-name').value;
                const deviceLocation = document.getElementById('device-location').value;
                const deviceCategory = categorySelect.value;
                const deviceType = typeSelect.value;

                if (!deviceName || !deviceLocation || !deviceCategory || !deviceType) {
                    alert('Please fill in all required fields');
                    submitBtn.textContent = 'Add Device';
                    submitBtn.disabled = false;
                    return;
                }

                // Create new device object
                const newDevice = {
                    id: Date.now(),
                    name: deviceName,
                    type: selectedDevice.label,
                    category: deviceCategory,
                    status: 'active',
                    icon: selectedDevice.icon,
                    location: deviceLocation,
                    settings: {},
                    usage: 0,
                    plan: plans.find(p => p.id === selectedPlan)?.name || 'Basic IoT',
                    addedDate: new Date().toISOString()
                };

                // Collect control settings
                const controlsContainer = document.getElementById('device-controls');
                controlsContainer.querySelectorAll('[data-control]').forEach(control => {
                    const controlKey = control.dataset.control;
                    let value;
                    
                    if (control.type === 'range') {
                        value = parseInt(control.value);
                    } else if (control.type === 'checkbox') {
                        value = control.checked;
                    } else if (control.type === 'color') {
                        value = control.value;
                    } else if (control.type === 'time') {
                        value = control.value;
                    } else {
                        value = control.value;
                    }
                    
                    newDevice.settings[controlKey] = value;
                });

                // Load existing devices and add new one
                loadDevices().then(existingDevices => {
                    const updatedDevices = [...existingDevices, newDevice];
                    return saveDevices(updatedDevices);
                }).then(success => {
                    if (success) {
                        successModal.classList.remove('hidden');
                    } else {
                        alert('Failed to save device. Please try again.');
                    }
                    submitBtn.textContent = 'Add Device';
                    submitBtn.disabled = false;
                }).catch(error => {
                    console.error('Error adding device:', error);
                    alert('An error occurred while adding the device.');
                    submitBtn.textContent = 'Add Device';
                    submitBtn.disabled = false;
                });
            }

            function resetForm() {
                successModal.classList.add('hidden');
                currentStep = 1;
                selectedDevice = null;
                selectedPlan = null;
                
                form.reset();
                showStep(1);
                
                discoverBtn.textContent = 'Discover Device';
                discoverBtn.disabled = false;
                discoverBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                discoverBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                
                planOptions.forEach(option => {
                    option.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
                    option.classList.add('border-gray-200', 'dark:border-gray-600');
                });
            }

            function handleThemeToggle() {
                document.documentElement.classList.toggle('dark');
                if (document.documentElement.classList.contains('dark')) {
                    themeIconSun.classList.remove('hidden');
                    themeIconMoon.classList.add('hidden');
                } else {
                    themeIconSun.classList.add('hidden');
                    themeIconMoon.classList.remove('hidden');
                }
            }

            // Initialize
            updateIdentifierLabel();
            lucide.createIcons();
            
            if (document.documentElement.classList.contains('dark')) {
                themeIconSun.classList.remove('hidden');
                themeIconMoon.classList.add('hidden');
            }
        });
    </script>
</body>
</html> 